@{
    ViewData["Title"] = "Dashboard de Gráficos";
}

<div class="row mb-4">
    <!-- TITULO -->
    <div class="col-12">
        <h1 class="h3 mb-2 text-gray-800">Dashboard de Análisis</h1>
        <p class="mb-4">Visualización gráfica de los indicadores clave de rendimiento (KPIs) del almacén.</p>
    </div>
</div>

<!-- FILA 1: GRÁFICO DE BARRAS (Entradas vs Salidas) -->
<div class="row">
    <div class="col-xl-12 col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Comparativa Entradas vs Salidas (Últimos 6 Meses)</h6>
            </div>
            <div class="card-body">
                <div class="chart-bar" style="height: 350px;">
                    <canvas id="myBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FILA 2: GRÁFICO DE DONA Y RESUMEN FINANCIERO -->
<div class="row">

    <!-- Top 5 Productos (Dona) -->
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Top 5 Productos Más Movidos</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4" style="height: 350px;">
                    <canvas id="myPieChart"></canvas>
                </div>
                <hr>
                <div class="small text-center text-muted">
                    Productos con mayor rotación (Ventas/Salidas)
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta Resumen Financiero -->
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-success">Resumen Financiero</h6>
            </div>
            <div class="card-body text-center">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                    Valor Total del Inventario
                </div>
                <div class="h1 mb-0 font-weight-bold text-gray-800 my-5">
                    @string.Format("{0:C}", ViewBag.ValorInventario)
                </div>
                <p class="mt-4 mb-0 text-gray-600">
                    Calculado en base al Costo Unitario Promedio x Stock Actual de todos los lotes.
                </p>
                <hr class="my-4">
                <a href="@Url.Action("Index", "Inventario")" class="btn btn-success btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-boxes"></i>
                    </span>
                    <span class="text">Ver Inventario Detallado</span>
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Page level plugins -->
    <script src="~/vendor/chart.js/Chart.min.js"></script>

    <script type="text/javascript">
        // Configuración común
        Chart.defaults.global.defaultFontFamily = 'Nunito', '-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif';
        Chart.defaults.global.defaultFontColor = '#858796';

        // ============================================
        // GRÁFICO DE BARRAS (Entradas vs Salidas)
        // ============================================
        var ctxBar = document.getElementById("myBarChart");
        
        // Recibir datos desde ViewBag (JSON)
        var labelsMeses = @Html.Raw(ViewBag.ChartLabels);
        var dataEntradas = @Html.Raw(ViewBag.ChartDataEntradas);
        var dataSalidas = @Html.Raw(ViewBag.ChartDataSalidas);

        var myBarChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labelsMeses,
                datasets: [
                    {
                        label: "Entradas",
                        backgroundColor: "#4e73df", // Azul Primary
                        hoverBackgroundColor: "#2e59d9",
                        borderColor: "#4e73df",
                        data: dataEntradas,
                    },
                    {
                        label: "Salidas",
                        backgroundColor: "#e74a3b", // Rojo Danger
                        hoverBackgroundColor: "#be2617",
                        borderColor: "#e74a3b",
                        data: dataSalidas,
                    }
                ],
            },
            options: {
                maintainAspectRatio: false,
                layout: {
                    padding: { left: 10, right: 25, top: 25, bottom: 0 }
                },
                scales: {
                    xAxes: [{
                        gridLines: { display: false, drawBorder: false },
                        ticks: { maxTicksLimit: 6 },
                        maxBarThickness: 25,
                    }],
                    yAxes: [{
                        ticks: {
                            min: 0,
                            maxTicksLimit: 5,
                            padding: 10,
                            callback: function(value, index, values) {
                                return value; // Añadir prefijo si se desea
                            }
                        },
                        gridLines: {
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                            drawBorder: false,
                            borderDash: [2],
                            zeroLineBorderDash: [2]
                        }
                    }],
                },
                legend: { display: true },
                tooltips: {
                    titleMarginBottom: 10,
                    titleFontColor: '#6e707e',
                    titleFontSize: 14,
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
            }
        });

        // ============================================
        // GRÁFICO DE DONA (Top 5 Productos)
        // ============================================
        var ctxPie = document.getElementById("myPieChart");
        
        var labelsProductos = @Html.Raw(ViewBag.TopProductosLabels);
        var dataProductos = @Html.Raw(ViewBag.TopProductosData);

        var myPieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: labelsProductos,
                datasets: [{
                    data: dataProductos,
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                cutoutPercentage: 80,
            },
        });
    </script>
}
